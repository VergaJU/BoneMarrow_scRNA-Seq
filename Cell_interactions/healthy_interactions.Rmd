---
title: "Liana_healthy"
author: "Jacopo Umberto Verga"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Cell cell interactions with liana

Environment:
```{r}
library(Seurat)
library(tidyverse)
library(magrittr)
library(liana)
library(BiocParallel)
```

Data and add corrected labels (cell types for all the cell types but the NK cells, they are labelled as exhausted. resident and others)
```{r}
dat <- readRDS("Data/healthy_interaction.Rds")# scRNA-Seq atlas

dat

```

Set ident as new added labels, normalize data and prepare for analysis with liana:
```{r}
dat <- SetIdent(dat, value="interaction_label")
dat <- NormalizeData(dat)
gc() # clean unused memory before running liana
```

Set multicore param (leave one core free for other jobs)

```{r}
multicoreParam <- MulticoreParam(workers = 11)
```

Run Liana with liana wrap
```{r}
#test_liana <- liana_wrap(dat,resource = "all", methods= show_methods(), BPPARAM = multicoreParam)
test_liana <- liana_wrap(dat, BPPARAM = multicoreParam)

```


```{r}
test_liana <- liana_aggregate(test_liana)
```


```{r fig.height=10, fig.width=10}
test_liana %>%
  liana_dotplot(source_groups = c("Plasma cells"),
                target_groups = c("NK exhausted", "NK resident", "Others"),
                ntop = 20)
```

```{r fig.height=10, fig.width=10}
test_liana %>%
  liana_dotplot(source_groups = c("NK exhausted", "NK resident", "Others"),
                target_groups = c("Plasma cells"),
                ntop = 20)
```
```{r fig.height=10, fig.width=10}
test_liana %>%
  liana_dotplot(source_groups = c("NK exhausted", "NK resident", "Others"),
                target_groups = c("NK exhausted", "NK resident", "Others"),
                ntop = 20)
```

```{r fig.height=10, fig.width=10}
liana_trunc <- test_liana %>%
   # only keep interactions concordant between methods
  filter(aggregate_rank <= 0.1) # note that these pvals are already corrected

heat_freq(liana_trunc)
```
```{r fig.height=12, fig.width=12}
p <- chord_freq(liana_trunc,
                source_groups = c("NK exhausted", "NK resident", "Others","Plasma cells"),
                target_groups = c("NK exhausted", "NK resident", "Others","Plasma cells"))
```

```{r}
write.csv(liana_trunc, "all_healthy_interactions_default.csv")
```
```{r}
gc()
```

